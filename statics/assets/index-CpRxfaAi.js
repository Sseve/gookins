import{k as b,r as G,l as H,s as J,c as h,a,w as l,m as K,h as x,E as i,b as d,o as m,e as u,p as Q,t as T,v as B,x as W,y as M}from"./index-y1BZ-Toa.js";import{s as c}from"./request-Sx4CXzmN.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Z=s=>c({url:"/task/add",method:"post",data:s}),ee=s=>c({url:"/task/upt",method:"put",data:s}),te=()=>c({url:"/task/list",method:"get"}),ne=s=>(console.log(s),c({url:"/task/run",method:"post",data:s})),ae=s=>c({url:`/task/cancel/${s}`,method:"post"}),le=s=>c({url:`/task/state/${s}`,method:"get"}),oe=s=>c({url:`/task/disable/${s}`,method:"post"}),se={class:"task-manager"},re={key:0,class:"pipeline-content"},ie={__name:"index",setup(s){const f=b([]),w=b(!1),y=b(null),g=b(!0),r=G({Id:"",Name:"",Description:"",PipeLine:""}),_=new Map,C=async()=>{try{g.value=!0;const e=await te();f.value=e.data}catch{i.error("获取任务列表失败")}finally{g.value=!1}},S=async e=>{try{const o=(await le(e.Name)).data;e.status=o,(o==="completed"||o==="cancelled"||o==="failed")&&k(e.Name)}catch(t){console.error(`更新任务状态失败: ${e.Name}`,t),k(e.Name)}},z=e=>{if(!_.has(e)){const t=setInterval(()=>S(f.value.find(o=>o.Name===e)),5e3);_.set(e,t)}},k=e=>{const t=_.get(e);t&&(clearInterval(t),_.delete(e))},D=e=>{y.value=e,e?Object.assign(r,{Id:e.Id,Name:e.Name,Description:e.Description,PipeLine:e.PipeLine}):Object.assign(r,{Id:"",Name:"",Description:"",PipeLine:""}),w.value=!0},I=async()=>{try{y.value?(await ee(r),i.success("任务更新成功")):(await Z(r),i.success("任务添加成功")),w.value=!1,await C()}catch{i.error(y.value?"更新任务失败":"添加任务失败")}},E=async e=>{if(e.disabled){i.warning("该任务已被禁用，无法运行");return}try{await ne({Id:e.Id,Name:e.Name,Description:e.Description,PipeLine:e.PipeLine}),e.status="running",i.success("任务开始运行"),z(e.Name)}catch(t){i.error("运行任务失败: "+t)}},P=async e=>{try{await M.confirm("确定要取消该任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ae(e.Name),e.status="cancelled",i.success("任务已取消"),k(e.Name)}catch(t){t!=="cancel"&&i.error("取消任务失败: "+t)}},U=async e=>{try{const t=e.disabled?"启用":"禁用";await M.confirm(`确定要${t}该任务吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await oe(e.Name),e.disabled=!e.disabled,i.success(`任务已${t}`),e.disabled&&e.status==="running"&&await P(e)}catch(t){t!=="cancel"&&i.error("操作失败: "+t)}},$={pending:{type:"info",text:"等待中"},running:{type:"warning",text:"运行中"},completed:{type:"success",text:"已完成"},cancelled:{type:"info",text:"已取消"},failed:{type:"danger",text:"失败"},success:{type:"success",text:"成功"}},j=e=>{var t;return((t=$[e])==null?void 0:t.type)||"info"},O=e=>{var t;return((t=$[e])==null?void 0:t.text)||"未知"};return H(()=>{C()}),J(()=>{_.forEach(e=>clearInterval(e))}),(e,t)=>{const o=d("el-button"),p=d("el-table-column"),L=d("el-tag"),A=d("el-table"),F=d("el-empty"),R=d("el-skeleton"),N=d("el-input"),v=d("el-form-item"),Y=d("el-form"),q=d("el-drawer");return m(),h("div",se,[a(o,{type:"primary",onClick:t[0]||(t[0]=n=>D(null)),icon:K(Q),size:"small"},{default:l(()=>t[6]||(t[6]=[u("新增任务")])),_:1},8,["icon"]),!g.value&&f.value.length>0?(m(),x(A,{key:0,data:f.value,style:{width:"100%","margin-top":"20px"}},{default:l(()=>[a(p,{prop:"ID",label:"ID",width:"80"}),a(p,{prop:"Name",label:"任务名称",width:"120"}),a(p,{prop:"Description",label:"任务描述",width:"120"}),a(p,{prop:"PipeLine",label:"流水任务",width:"200"},{default:l(n=>[n.row?(m(),h("div",re,T(n.row.PipeLine),1)):B("",!0)]),_:1}),a(p,{label:"操作",width:"360"},{default:l(n=>[a(o,{size:"small",onClick:V=>D(n.row)},{default:l(()=>t[7]||(t[7]=[u("更新")])),_:2},1032,["onClick"]),a(o,{size:"small",type:"primary",onClick:V=>E(n.row),loading:n.row.status==="running",disabled:n.row.status==="running"||n.row.disabled},{default:l(()=>t[8]||(t[8]=[u(" 运行 ")])),_:2},1032,["onClick","loading","disabled"]),a(o,{size:"small",type:"danger",onClick:V=>P(n.row),disabled:n.row.status!=="running"},{default:l(()=>t[9]||(t[9]=[u(" 取消 ")])),_:2},1032,["onClick","disabled"]),a(o,{size:"small",type:n.row.disabled?"success":"warning",onClick:V=>U(n.row)},{default:l(()=>[u(T(n.row.disabled?"启用":"禁用"),1)]),_:2},1032,["type","onClick"])]),_:1}),a(p,{label:"状态"},{default:l(n=>[a(L,{type:j(n.row.status)},{default:l(()=>[u(T(O(n.row.status)),1)]),_:2},1032,["type"]),n.row.disabled?(m(),x(L,{key:0,type:"info",class:"ml-2"},{default:l(()=>t[10]||(t[10]=[u("已禁用")])),_:1})):B("",!0)]),_:1})]),_:1},8,["data"])):!g.value&&f.value.length===0?(m(),x(F,{key:1,description:"暂无任务"})):(m(),x(R,{key:2,rows:5,animated:""})),a(q,{modelValue:w.value,"onUpdate:modelValue":t[5]||(t[5]=n=>w.value=n),title:y.value?"更新任务":"新增任务",size:"40%"},{default:l(()=>[a(Y,{model:r,"label-width":"100px",onSubmit:W(I,["prevent"])},{default:l(()=>[a(v,{label:"任务名称"},{default:l(()=>[a(N,{modelValue:r.Name,"onUpdate:modelValue":t[1]||(t[1]=n=>r.Name=n)},null,8,["modelValue"])]),_:1}),a(v,{label:"任务描述"},{default:l(()=>[a(N,{modelValue:r.Description,"onUpdate:modelValue":t[2]||(t[2]=n=>r.Description=n)},null,8,["modelValue"])]),_:1}),a(v,{label:"流水任务"},{default:l(()=>[a(N,{modelValue:r.PipeLine,"onUpdate:modelValue":t[3]||(t[3]=n=>r.PipeLine=n),type:"textarea",rows:5,placeholder:"请输入YAML格式的流水线任务"},null,8,["modelValue"])]),_:1}),a(v,null,{default:l(()=>[a(o,{type:"primary",onClick:I},{default:l(()=>[u(T(y.value?"更新":"添加"),1)]),_:1}),a(o,{onClick:t[4]||(t[4]=n=>w.value=!1)},{default:l(()=>t[11]||(t[11]=[u("取消")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},pe=X(ie,[["__scopeId","data-v-25436198"]]);export{pe as default};
